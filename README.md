# Gemini MCP Server for Instana Verification

This is a simple Model Context Protocol (MCP) server that integrates with Google's Gemini models. It is designed to replace the "weather" example in Instana's MCP observability documentation to demonstrate how to instrument an MCP server with Traceloop and send traces to Instana.

## Prerequisites

- **Client**: Windows 11 with Claude Desktop
- **Server**: WSL2 (Windows Subsystem for Linux) with Ubuntu 22.04.5 LTS
- Python 3.10+
- A Google Cloud Project with the Gemini API enabled and an API Key.
- Instana Agent (running locally) OR Instana Backend OTLP Endpoint (for agentless mode).

## Setup

1.  **Clone/Navigate to the directory**:
    ```bash
    cd gemini-mcp-server
    ```

2.  **Create and activate a virtual environment (in WSL2 Ubuntu)**:
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3.  **Install dependencies**:
    ```bash
    pip install -r requirements.txt
    ```

## Configuration & Usage

You can run this server directly via Claude Desktop or any MCP Client.

### Environment Variables

You need to provide the following environment variables. You can set them in a `.env` file (if running manually) or in your Claude Desktop configuration.

-   `GOOGLE_API_KEY`: Your Gemini API Key.
-   `GEMINI_MODEL`: (Optional) The model to use. Defaults to `models/gemini-2.5-flash`. You can set this to `models/gemini-3-pro-image-preview` if you have access.

### WSL2 Ubuntu Environment Example Settings

**In WSL2 Ubuntu terminal:**

```bash
export GOOGLE_API_KEY="YOUR_GOOGLE_API_KEY_HERE"
export GEMINI_MODEL="gemini-2.5-flash-image"
export TRACELOOP_BASE_URL="http://localhost:4318"
export TRACELOOP_HEADERS="x-instana-key=YOUR_INSTANA_KEY_HERE"
export OTEL_EXPORTER_OTLP_INSECURE="true"

# Start the server
python gemini_server.py
```


**Instana Tracing Variables:**

*   **Agent Mode (Local Instana Agent):**
    *   `TRACELOOP_BASE_URL=http://localhost:4318`
    *   `TRACELOOP_HEADERS="x-instana-key=<your-agent-key>"`
    *   `OTEL_EXPORTER_OTLP_INSECURE=true`

*   **Agentless Mode (Direct to Backend):**
    *   `TRACELOOP_BASE_URL=<your-instana-otlp-endpoint>` (e.g., `https://otlp-pink-saas.instana.rocks:4318` if using HTTP)
    *   `TRACELOOP_HEADERS="x-instana-key=<your-agent-key>"`
    *   `OTEL_EXPORTER_OTLP_INSECURE=false`

### Claude Desktop Configuration

Since the server runs as a persistent web service (streamable-http), Claude Desktop connects to it via the `mcp-remote` npm package.

**1. Start the Server with Environment Variables:**

In your terminal, inside the `gemini-mcp-server` directory (with venv activated), set all environment variables and start the server:

```bash
# Set server environment variables
export GOOGLE_API_KEY="your-google-api-key"
export GEMINI_MODEL="gemini-2.5-flash-image"
export TRACELOOP_BASE_URL="http://localhost:4318"
export TRACELOOP_HEADERS="x-instana-key=your-instana-key"
export OTEL_EXPORTER_OTLP_INSECURE="true"

# Start the server
python gemini_server.py
```

You should see output indicating `Uvicorn running on http://127.0.0.1:8000`.

**2. Configure Claude Desktop (on Windows 11):**

Edit your Claude Desktop configuration file at:
- Windows path: `%APPDATA%\Claude\claude_desktop_config.json`

```json
{
  "mcpServers": {
    "gemini": {
      "command": "npx",
      "args": [
        "mcp-remote",
        "http://localhost:8000/mcp"
      ]
    }
  }
}
```

*Note: All environment variables are set on the server side (step 1). The `mcp-remote` proxy doesn't need them.*



## Verification Steps

1.  Restart Claude Desktop.
2.  Look for the plug icon to confirm the "gemini" server is connected.
3.  Ask Claude like: "Ask Gemini to create a 3D image for Instana architecture."
4.  **Test Image Generation**:
    - Ask Claude: "Generate an image of a futuristic city."
    - Claude should return an image generated by the provided model.
5.  Check your Instana Dashboard:
    - Go to **GenAI Observability**.
    - Look for a service named `gemini-mcp-server`.
    - Click it then you can see traces for `generate_image` etc.. calls.
